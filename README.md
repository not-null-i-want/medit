#  👨‍⚕️ Team 낫널원해 : MEDIT
<div align="center">
  
![ppt_front](https://github.com/not-null-i-want/medit/assets/145624456/0919f029-f375-4106-a0a4-d4bcd180c3b9)
</div>

## 📑 프로젝트 소개
### `주제 : ResNet50 모델 기반 폐 질환 진단 서비스`
- 스마트인재개발원 인공지능 융합서비스 과정의 마지막 프로젝트로써 기업의 멘토링을 받아 개발하였습니다.
- 의료인들에게 즉각적으로 드러나지 않을 수 있는 패턴을 식별 가능하게 하여 질환을 조기에 발견함으로써 적시에 개입할 수 있고 **오진을 막는데에 도움**을 주고자 합니다.
- 일관되고 객관적인 분석을 제공하여 **효과적인 치료 계획을 설립**할 수 있도록 합니다.
- 의료인이 부족하다면 보조 진단 도구 역할을 하여 **의사 결정에 도움**을 줄 수 있도록 합니다.
<br>

## 📅 프로젝트 기간
- **계획 / 분석 / 설계** : 　２４. ０１. １７ ~ ２４. ０２. １２
- 　　　**구현**　　 　: 　２４. ０２. １３ ~ ２４. ０３. ０６
<br>

## 🔨 사용 기술

<table>
    <tr>
        <th>구분</th>
        <th>내용</th>
    </tr>
    <tr>
        <td>Back-end</td>
        <td>
            <img src="https://img.shields.io/badge/Java-007396?style=for-the-badge&logo=java&logoColor=white"/>
	    <img src="https://img.shields.io/badge/spring-6DB33F?style=for-the-badge&logo=spring&logoColor=white">
            <img src="https://img.shields.io/badge/Spring%20Boot-6DB33F?style=for-the-badge&logo=Spring%20Boot&logoColor=white">
            <img src="https://img.shields.io/badge/Apache%20Maven-C71A36?style=for-the-badge&logo=Apache%20Maven&logoColor=white"/>
            <img src="https://img.shields.io/badge/javascript-F7DF1E?style=for-the-badge&logo=javascript&logoColor=black">
            <img src="https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=Python&logoColor=white"/>
        </td>
    </tr>
    <tr>
        <td>Front-end</td>
        <td>
            <img src="https://img.shields.io/badge/html5-E34F26?style=for-the-badge&logo=html5&logoColor=white">
            <img src="https://img.shields.io/badge/css-1572B6?style=for-the-badge&logo=css3&logoColor=white">
            <img src="https://img.shields.io/badge/javascript-F7DF1E?style=for-the-badge&logo=javascript&logoColor=black">
            <img src="https://img.shields.io/badge/Thymeleaf-%23005C0F?style=for-the-badge&logo=Thymeleaf&logoColor=black">
        </td>
    </tr>
    <tr>
        <td>Database</td>
        <td>
            <img src="https://img.shields.io/badge/oracle-F80000?style=for-the-badge&logo=oracle&logoColor=white">
        </td>
    </tr>
    <tr>
        <td>Server</td>
        <td>
            <img src="https://img.shields.io/badge/apache tomcat-F8DC75?style=for-the-badge&logo=apachetomcat&logoColor=white">
            <img src="https://img.shields.io/badge/flask-%23000?style=for-the-badge&logo=flask&logoColor=white">
        </td>
    </tr>
   <tr>
        <td>Distribution</td>
        <td>
            <img src="https://img.shields.io/badge/AWS ec2-FF9900?style=for-the-badge&logo=amazonec2&logoColor=white">
            <img src="https://img.shields.io/badge/AWS s3-569A31?style=for-the-badge&logo=amazons3&logoColor=white">
        </td>
    </tr>
    <tr>
        <td>Library & API</td>
        <td>
            <img src="https://img.shields.io/badge/jquery-0769AD?style=for-the-badge&logo=jquery&logoColor=white">
	    <img src="https://img.shields.io/badge/Spring Data JPA-bcae79?style=for-the-badge&logo=&logoColor=white"/>
            <img src="https://img.shields.io/badge/Canvas-007CE2?style=for-the-badge&logo=Canvs&logoColor=white">
            <img src="https://img.shields.io/badge/chart.js-F5788D?style=for-the-badge&logo=chart.js&logoColor=white">
            <img src="https://img.shields.io/badge/kakaoMap API-FFCD00?style=for-the-badge&logo=kakao&logoColor=white">
			<img src="https://img.shields.io/badge/pytorch-EE4C2C?style=for-the-badge&logo=pytorch&logoColor=white">
			<img src="https://img.shields.io/badge/opencv-5C3EE8?style=for-the-badge&logo=opencv&logoColor=white">
        </td>
    </tr>
    <tr>
        <td>IDT</td>
        <td>
            <img src="https://img.shields.io/badge/eclipse-2C2255?style=for-the-badge&logo=eclipseide&logoColor=white">
            <img src="https://img.shields.io/badge/Visual%20Studio%20Code-0078d7?style=for-the-badge&logo=visual-studio-code&logoColor=white"/>
            <img src="https://img.shields.io/badge/SQL Developer-777777?style=for-the-badge&logo=&logoColor=white"/>
            <img src="https://img.shields.io/badge/AWS-%23FF9900?style=for-the-badge&logo=amazon-aws&logoColor=white"/>
        </td>
    </tr>
    <tr>
        <td>Etc.</td>
        <td>
            <img src="https://img.shields.io/badge/git-F05032?style=for-the-badge&logo=git&logoColor=white">
            <img src="https://img.shields.io/badge/github-181717?style=for-the-badge&logo=github&logoColor=white">
        </td>
    </tr>
    
</table>
<br>

## 🗃 시스템 아키텍처
<div align="center">

![medit architecture](https://github.com/not-null-i-want/medit/assets/145624456/67a20768-3b6c-43d4-a896-cb0d7678e5de)
 </div>

## 🎫 ERD
![medit DB](https://github.com/not-null-i-want/medit/assets/145624456/27d0f475-2145-46f1-b0d6-8dd9d013117f)
<br>

## 🔌 구성 및 흐름도
![medit flow](https://github.com/not-null-i-want/medit/assets/145624456/332e44a8-a306-4784-806f-f9eeb1879ad7)
<br>

## ✒ 구현 전 화면설계
<br>
<details>
<summary><b>화면설계 펼치기</b></summary>
<div markdown="1">
	
![Login](https://github.com/not-null-i-want/medit/assets/145624456/7303b72c-11eb-4f8d-b59c-b6cf4819d8f9)
![Main](https://github.com/not-null-i-want/medit/assets/145624456/546b4c29-6611-4703-8677-907b247a7b92)
![PatientRegistration](https://github.com/not-null-i-want/medit/assets/145624456/a0d7c99d-4f93-4374-bdf5-3af5939a9c73)
![Diag](https://github.com/not-null-i-want/medit/assets/145624456/ad87a368-89be-4b43-bd15-9910ab414bde)
![Select](https://github.com/not-null-i-want/medit/assets/145624456/ee4ce8db-0c2e-47d6-81ee-572b7cb9bdc0)
![Select2](https://github.com/not-null-i-want/medit/assets/145624456/76bad73e-1dd2-4b4c-bfd3-a05508f651fc)
![Messanger](https://github.com/not-null-i-want/medit/assets/145624456/559060c2-aeda-4077-b5df-b600a4fe5a68)
</div>
</details>
<br>

## 📚 주요 기능
###### (문장을 클릭하면 자세히 볼 수 있습니다.)
<details>
<summary><b>로그인을 제외한 모든 기능 비동기화</b></summary>
<div markdown="1">
	
![image](https://github.com/not-null-i-want/medit/assets/145624456/b1f97539-909e-4066-97e0-5991a5c69bfd)
</div>
</details>

<details>
<summary><b>환자를 관리할 수 있는 기본적인 기능(환자 추가, 환자 검색 및 환자 목록, 환자 정보 상세보기, 소견서 작성 및 수정 등)</b></summary>
<div markdown="1">

- 환자 등록<br>
![환자등록](https://github.com/not-null-i-want/medit/assets/145624456/3d4b5ed2-2c39-4f27-9e4b-4404ccedc89b)

- 환자 목록 및 검색, 상세 정보<br>
![환자검색, 상세목록](https://github.com/not-null-i-want/medit/assets/145624456/1f1b814d-479c-4b68-a7a1-d5f5bc43b1bd)

- 소견 작성 및 수정<br>
![소견작성](https://github.com/not-null-i-want/medit/assets/145624456/ef71e151-f39d-4a68-a9b0-6b9d43d2cdd4)
</div>
</details>

<details>
<summary><b>웹소켓을 이용하여 실시간 통신을 가능하게함으로써 의료진들의 일대일 채팅 지원</b></summary>
<div markdown="1">

![채팅](https://github.com/not-null-i-want/medit/assets/145624456/774a9d77-2997-4125-8a46-5881c6350b8e)
</div>
</details>

<details>
<summary><b>효율적인 데이터 로딩과 가독성을 위해 목록을 출력해주는 기능들의 페이징 처리(환자 목록, 진료 날짜 목록)</b></summary>
<div markdown="1">

![페이징](https://github.com/not-null-i-want/medit/assets/145624456/61d429be-33b7-4890-8928-bcc53dd92465)
</div>
</details>

<details>
<summary><b>사용자가 확인할 수 있는 각 질환에 해당하는 CXR 제공(비교군)</b></summary>
<div markdown="1">

![비교군](https://github.com/not-null-i-want/medit/assets/145624456/e589100b-c56d-44d0-966b-40b9aaf28f53)
</div>
</details>

<details>
<summary><b>HTML5 Canvas를 이용한 CXR 편집(그리기, 펜 굵기 조절, 색 변경, ON/OFF 토글, 클리어)</b></summary>
<div markdown="1">

![canvas](https://github.com/not-null-i-want/medit/assets/145624456/41d22ba5-f142-4fcf-808d-278411d1c401)
</div>
</details>

<details>
<summary><b>딥러닝으로 진단된 각 질환에 대한 확률값들을 Chart.js로 그래프화</b></summary>
<div markdown="1">

![그래프](https://github.com/not-null-i-want/medit/assets/145624456/94abb003-71a9-4f98-811a-41398ae9d4cb)
</div>
</details>

<details>
<summary><b>CXR 이미지 업로드 즉시 ResNet 모델을 이용하여 결과를 추론하고 확률 및 레이블 처리, CAM(Class Activation Map 이미지 생성</b></summary>
<div markdown="1">

- **결과 추론 과정**
  
	---

	1. **모델 및 관련 설정**: 코드는 ResNet 모델을 사용하며, 이 모델은 torchXrayVision패키지에서 가져온 것입니다. 모델은 사전 학습된 가중치인 "resnet50-res512-all"로 초기화되며, GradCAM을 통해 어떤 레이어를 타겟으로 할 것인지 정의합니다.
   
	2. **이미지 다운로드 및 로드**: 사용자가 제공한 이미지 URL을 사용하여 이미지를 다운로드하고, OpenCV를 사용하여 이미지를 로드합니다. 이미지는 그레이스케일로 변환되어 처리됩니다.
   
	3. **이미지 전처리 및 테스트**: 이미지는 다양한 크기로 조정되며, 필요에 따라 히스토그램 평활화와 이미지 반전이 적용됩니다. 그 후, 이미지는 모델의 입력 형식에 맞게 정규화되고, 모델을 통해 테스트됩니다.

	4. **결과 처리**: 추론된 결과는 확률 및 레이블로 처리됩니다. 결과에 대한 적절한 처리가 수행된 후, 해당 결과를 반환하고 화면에 표시됩니다.
   
	5. **이미지 생성 및 업로드**: 결과가 정상이 아닌 경우, CAM (Class Activation Map) 이미지가 생성되고 S3에 업로드됩니다. CAM 이미지는 모델이 어떤 부분을 보고 각 결과를 도출했는지 시각적으로 보여줍니다.

	<br>

- **기존 torchXrayVision에 추가 작업**

  	---
  
  	1. **GradCAM 적용**: GradCAM(Gradient-weighted Class Activation Mapping)은 모델의 활성화를 시각화하고, 모델이 예측에 사용한 중요한 영역을 확인하는 데 사용됩니다. 코드에서는 GradCAM을 사용하여 모델이 예측한 결과에 대한 활성화 맵을 생성하고 시각화하는 과정이 추가되었습니다.<br>

	<div align="center">
		
  	![image](https://github.com/not-null-i-want/medit/assets/145624456/a0e72cf8-3030-449d-828f-897e7faef53e)
	</div>

	---

 	2. **TTA(Test-Time Augmentation) 적용**: TTA는 테스트 시에 데이터 증강을 적용하여 모델의 성능을 향상시키는 기법입니다. 코드에서는 TTA를 적용하여 이미지를 여러 크기로 조정하고, 히스토그램 평활화 및 이미지 뒤집기 등의 데이터 증강 기법을 적용하여 모델의 예측 정확도를 높이는 작업이 수행되었습니다.
     
     	- **히스토그램 평활화(Histogram Equalization)**: 이미지의 대비를 향상시키기 위해 히스토그램을 조정하는 기술입니다. 이를 통해 어두운 이미지의 세부 정보를 뚜렷하게 표현할 수 있습니다.
     
	    - **이미지 반전(Flip)**: 이미지를 좌우로 뒤집어 증강시키는 것으로, 데이터의 다양성을 높이고 모델이 다양한 각도에서 이미지를 이해할 수 있도록 돕습니다.
 
  	<div align="center">
		
  	![image](https://github.com/not-null-i-want/medit/assets/145624456/997a3374-6c3e-46bb-89a2-04b0a66f76c3)
	</div>

	---

 	3. **맵핑 및 결과 처리**: 모델이 출력하는 각 병변에 대한 확률을 분석하여 특정 임계값 이상인 경우에만 해당 병변으로 판정합니다. 또한, GradCAM을 통해 생성된 활성화 맵을 사용하여 특정 병변과 관련된 이미지 영역을 시각화하고, 이를 사용자에게 제공합니다.
     
		- 모델의 출력에서 각 병변에 대한 확률 분석, 특정 임계값 이상인 경우에만 해당 병변으로 판단합니다.
	   	<div align="center">
			
	  	![image](https://github.com/not-null-i-want/medit/assets/145624456/17092413-648e-4355-ba39-9bb22d9442c4)
		</div>

  		- GradCAM을 통해 생성된 활성화 맵을 사용하여 특정 병변과 관련된 이미지 영역을 시각화하여 사용에게 제공합니다.
		<div align="center">
			
	  	![image](https://github.com/not-null-i-want/medit/assets/145624456/6f23589f-67ab-481a-a382-8381fad58657)
		</div>

	---

  	4. **aws s3로의 이미지 업로드 및 URL 반환**: 처리된 이미지를 AWS S3에 업로드하고, 업로드된 이미지의 URL을 스프링부트로 전송합니다.

	---
  
  	5. **마스킹 작업**
  	   
  		１. 테스트된 확률값과 CAM(클래스 활성화 맵)을 기반으로 한 임계값을 설정합니다.
	  	![image](https://github.com/not-null-i-want/medit/assets/145624456/0a9e46ce-7af9-41ea-a6a1-6c82e3f73123)

  		２. 임계값보다 높은 확률을 가진 레이블에 대해서만 마스킹을 진행합니다.<br>
	  	![image](https://github.com/not-null-i-want/medit/assets/145624456/d5ad2058-a52f-41ac-bfb3-850f8b667967)


  		３. 마스킹을 위해 CAM을 정규화합니다.<br>
	  	![image](https://github.com/not-null-i-want/medit/assets/145624456/9124ffb1-8fe3-4034-9912-8f3aa8e621ee)


  		４. 가우시안 블러(Gaussian Blur)를 적용하여 CAM을 부드럽게 만듭니다.
	  	![image](https://github.com/not-null-i-want/medit/assets/145624456/f25552e8-8d83-42cd-80f2-de0b4023e496)


  		５. CAM에서 특정 임계값 이상의 윤곽선을 추출합니다.
	  	![image](https://github.com/not-null-i-want/medit/assets/145624456/7aacb65b-d295-4815-9c15-9edb2764913f)


  		６. 추출된 윤곽선을 기반으로 병변 영역을 표시하기 위해 히트맵을 생성합니다.
	  	![image](https://github.com/not-null-i-want/medit/assets/145624456/32bfd0f8-f1b8-4a71-8d44-604c94e40ffc)


  		７. 히트맵과 윤곽선을 원본 이미지에 겹쳐서 마스킹된 이미지를 생성합니다.
	  	![image](https://github.com/not-null-i-want/medit/assets/145624456/e7303c18-e6f5-440b-be65-4d9492cb15d7)

<br>
<br>
<br>

- **추가 작업 후 변경점**

---

  - 추가 전<br>
  ![image](https://github.com/not-null-i-want/medit/assets/145624456/aaea8950-f72c-4520-a9a4-3b29853059e3)


  - 추가 후<br>
  ![image](https://github.com/not-null-i-want/medit/assets/145624456/4506eb19-b883-4a6e-8b5e-3ac5433ae173)

</div>
</details>

<br>

## 🧩 트러블 슈팅

### [정연희]

### [김병훈]

<details>
<summary><b>ERR_INCOMPLETE_CHUNKED_ENCODING 200</b></summary>
<div markdown="1">

---

　🧨 오류 내용
- 양방향으로 연결된 Entity를 그대로 조회하는 경우 서로의 정보를 순환하면서 조회하다가 Stackoverflow가 발생하게 되었음
- 이를 순환참조라고 하며, 참조하는 대상이 서로 물려있어 참조할 수 없게 되는 현상을 일컫는다.

　💡 해결 방법
- **@JsonIgnore** : JSON 데이터에 해당 프로퍼티는 null로 들어가게 된다. 해당하는 프로퍼티도 넘겨줘야 했기 때문에 이 방법은 사용하지 않았음
- **@JsonManagedReference & @JsonBackReference** : 부모 클래스의 필드에 @JsonManagedReference를, 자식 클래스의 필드에 @JsonBackReference를 추가하여 순환참조를 막는다. **이 방법으로 해결하였음**
- **DTO 사용** : 오류가 발생하게 된 주원인은 '양방향 매핑'이기도 하지만, 더 정확하게는 Entity 자체를 Response로 리턴한데에 있다. Entity 자체를 Return 하지 않고, DTO 객체를 만들어 필요한 데이터만 옮겨담아 Client로 리턴하면 순환 참조 관련 문제를 방지 할 수 있다.
- **매핑 재설정** : 만약 양방향 매핑이 필요가 없다면 단방향 매핑을 해줘서 자연스레 순환 참조 문제를 해결할 수 있다.

![image](https://github.com/not-null-i-want/medit/assets/145624456/58898a99-00c3-421f-a716-47e4ee71319d)

</div>
</details>

### [윤수민]

<details>
<summary><b>Failed to connect to service endpoint</b></summary>
<div markdown="1">

---

　🧨 오류 내용

	com.amazonaws.SdkClientException: Failed to connect to service endpoint:
	Caused by: java.net.SocketTimeoutException: connect timed out

　💡 해결 방법
- spring-cloud-starter-aws 의존성 주입시 로컬환경은 AWS환경이 아니기때문에 발생한다.
- 아래 구문을 SpringBootApplication에 적용하였음

```java
@SpringBootApplication(
      exclude = {
              org.springframework.cloud.aws.autoconfigure.context.ContextInstanceDataAutoConfiguration.class,
              org.springframework.cloud.aws.autoconfigure.context.ContextStackAutoConfiguration.class,
              org.springframework.cloud.aws.autoconfigure.context.ContextRegionProviderAutoConfiguration.class
      }
 )
```

</div>
</details>

<details>
<summary><b>AmazonS3Exception: The specified bucket does not exist</b></summary>
<div markdown="1">

---

　🧨 오류 내용
 
![image](https://github.com/not-null-i-want/medit/assets/145624456/26c3db5b-d2c0-49b4-b8f2-56bc52e3de25)

　💡 해결 방법
- 버킷명은 유일해야 한다.
- yml이나 properties 파일에서 버킷명이 알맞게 입력됐나 점검, 수정하였음

</div>
</details>

<details>
<summary><b>java.io.UncheckedIOException: Cannot delete</b></summary>
<div markdown="1">

---

　🧨 오류 내용
 
```
java.io.UncheckedIOException: Cannot delete C:\Users\smhrd\AppData\Local\Temp\tomcat.8089.1070292282324288404\work\Tomcat\localhost\medit\upload_09e1bcb3_1796_4afb_b0a8_86783c1dc4d2_00000001.tmp
...
Caused by: java.io.IOException: Cannot delete C:\Users\smhrd\AppData\Local\Temp\tomcat.8089.1070292282324288404\work\Tomcat\localhost\medit\upload_09e1bcb3_1796_4afb_b0a8_86783c1dc4d2_00000001.tmp
...
java.io.UncheckedIOException: Cannot delete C:\Users\smhrd\AppData\Local\Temp\tomcat.8089.1070292282324288404\work\Tomcat\localhost\medit\upload_09e1bcb3_1796_4afb_b0a8_86783c1dc4d2_00000001.tmp
...
2024-02-13 18:46:15.802 ERROR 4908 --- [nio-8089-exec-1] org.apache.tomcat.util.net.NioEndpoint   : Error running socket processor
```

　💡 해결 방법
- 스프링부트 버전 문제로 발생
- 버전을 2.7.6으로 변경하였음

```xml
<parent>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-parent</artifactId>
      <version>2.7.6</version>
      <relativePath/>
</parent>
```

</div>
</details>

<details>
<summary><b>com.fasterxml.jackson.databind.exc.InvalidDefinitionException</b></summary>
<div markdown="1">

---

　🧨 오류 내용




　💡 해결 방법
- spring-cloud-starter-aws 의존성 주입시 로컬환경은 AWS환경이 아니기때문에 발생한다.
- 아래 구문을 SpringBootApplication에 적용하였음

```java
@SpringBootApplication(
      exclude = {
              org.springframework.cloud.aws.autoconfigure.context.ContextInstanceDataAutoConfiguration.class,
              org.springframework.cloud.aws.autoconfigure.context.ContextStackAutoConfiguration.class,
              org.springframework.cloud.aws.autoconfigure.context.ContextRegionProviderAutoConfiguration.class
      }
 )
```

</div>
</details>

### [이동훈]

<details>
<summary><b>OMP: Error #15: Initializing libiomp5md.dll, but found libiomp5md.dll already initialized.</b></summary>
<div markdown="1">

---

　🧨 오류 내용

 - 각종 커널(라이브러리)들의 충돌이 발생

　💡 해결 방법
- openmp 커널 충돌 방지를 위해 코드를 입력하였음

```py
import os
os.environ['KMP_DUPLICATE_LIB_OK'] = 'True'
```

</div>
</details>
